"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const SharedErrors = __importStar(require("../../../../../../shared/errors"));
const EXECUTION_CTX_WAS_DESTROYED_CODE = -32000;
const SELECTOR_MAX_EXECUTE_COUNT = 10;
const PROXYLESS_SCRIPT = 'window["%proxyless%"]';
class ClientFunctionExecutor {
    constructor() {
        // new Map<frameId, executionContextId>
        this._frameExecutionContexts = new Map();
        this._currentFrameId = '';
    }
    async evaluateScript(Runtime, expression) {
        const script = { expression, awaitPromise: true };
        if (this._currentFrameId && this._frameExecutionContexts.has(this._currentFrameId))
            script.contextId = this._frameExecutionContexts.get(this._currentFrameId);
        try {
            const { result, exceptionDetails = null } = await Runtime.evaluate(script);
            return { result, exceptionDetails, error: null };
        }
        catch (error) {
            return { result: null, exceptionDetails: null, error };
        }
    }
    async _evaluateScriptWithReloadPageIgnore(Runtime, expression) {
        let attempts = 0;
        let result;
        let exceptionDetails;
        let error;
        while (attempts++ < SELECTOR_MAX_EXECUTE_COUNT) {
            ({ result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression));
            if (error && error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                continue;
            break;
        }
        // eslint-disable-next-line @typescript-eslint/no-object-literal-type-assertion
        return { result, exceptionDetails, error };
    }
    static _getPropertyByName(properties, name) {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return properties.find(prop => prop.name === name).value;
    }
    static _throwException(details, command, callsite) {
        var _a;
        const exception = details.exception;
        if (exception) {
            const className = exception.className;
            const properties = (_a = exception.preview) === null || _a === void 0 ? void 0 : _a.properties;
            if (className === SharedErrors.UncaughtErrorInCustomDOMPropertyCode.name) {
                throw new SharedErrors.UncaughtErrorInCustomDOMPropertyCode(command.instantiationCallsiteName, ClientFunctionExecutor._getPropertyByName(properties, 'errMsg'), ClientFunctionExecutor._getPropertyByName(properties, 'property'), callsite);
            }
            else if (className === SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError.name) {
                throw new SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.ActionElementNotFoundError.name) {
                throw new SharedErrors.ActionElementNotFoundError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.DomNodeClientFunctionResultError.name)
                throw new SharedErrors.DomNodeClientFunctionResultError(command.instantiationCallsiteName, callsite);
            else if (className === SharedErrors.InvalidSelectorResultError.name)
                throw new SharedErrors.InvalidSelectorResultError(callsite);
            else if (className === SharedErrors.ActionElementIsInvisibleError.name)
                throw new SharedErrors.ActionElementIsInvisibleError(callsite);
        }
        throw new SharedErrors.UncaughtErrorInClientFunctionCode(command.instantiationCallsiteName, details.text, callsite);
    }
    async executeClientFunction(Runtime, command, callsite) {
        const expression = `${PROXYLESS_SCRIPT}.executeClientFunctionCommand(${JSON.stringify(command)});`;
        const { result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression);
        if (error) {
            if (error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                throw new SharedErrors.ClientFunctionExecutionInterruptionError(command.instantiationCallsiteName, callsite);
            throw error;
        }
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        return JSON.parse(result.value); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    async executeSelector(args) {
        const { Runtime, command, callsite, selectorTimeout, errCtors } = args;
        const returnNodeObjId = 'DOM' in args;
        const expression = `${PROXYLESS_SCRIPT}.executeSelectorCommand(${JSON.stringify(command)}, ${selectorTimeout}, ${Date.now()},
                                 ${returnNodeObjId}, ${JSON.stringify(errCtors)});`;
        const { result, exceptionDetails, error } = await this._evaluateScriptWithReloadPageIgnore(Runtime, expression);
        if (error)
            throw error;
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return returnNodeObjId ? result.objectId : JSON.parse(result.value);
    }
    async getNode(args) {
        const objectId = await this.executeSelector(args);
        const response = await args.DOM.describeNode({ objectId });
        return response.node;
    }
    setupFramesWatching(Runtime) {
        Runtime.on('executionContextCreated', (event) => {
            var _a;
            if (!((_a = event.context.auxData) === null || _a === void 0 ? void 0 : _a.frameId))
                return;
            this._frameExecutionContexts.set(event.context.auxData.frameId, event.context.id);
        });
        Runtime.on('executionContextDestroyed', (event) => {
            for (const [frameId, executionContextId] of this._frameExecutionContexts.entries()) {
                if (executionContextId === event.executionContextId)
                    this._frameExecutionContexts.delete(frameId);
            }
        });
        Runtime.on('executionContextsCleared', () => {
            this._currentFrameId = '';
            this._frameExecutionContexts.clear();
        });
    }
    setCurrentFrameId(frameId) {
        this._currentFrameId = frameId;
    }
}
exports.default = ClientFunctionExecutor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LWZ1bmN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAtY2xpZW50L2NsaWVudC1mdW5jdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFZQSw4RUFBZ0U7QUFpQ2hFLE1BQU0sZ0NBQWdDLEdBQUcsQ0FBQyxLQUFLLENBQUM7QUFDaEQsTUFBTSwwQkFBMEIsR0FBUyxFQUFFLENBQUM7QUFDNUMsTUFBTSxnQkFBZ0IsR0FBbUIsdUJBQXVCLENBQUM7QUFHakUsTUFBcUIsc0JBQXNCO0lBQTNDO1FBQ0ksdUNBQXVDO1FBQ3RCLDRCQUF1QixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQzdELG9CQUFlLEdBQVcsRUFBRSxDQUFDO0lBa0p6QyxDQUFDO0lBaEpVLEtBQUssQ0FBQyxjQUFjLENBQUUsT0FBbUIsRUFBRSxVQUFrQjtRQUNoRSxNQUFNLE1BQU0sR0FBb0IsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxDQUFDO1FBRW5FLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDOUUsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUU5RSxJQUFJO1lBQ0EsTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsR0FBRyxJQUFJLEVBQUUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFM0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENB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QUMseUJBQXlCLEVBQUUsQ0FBQyxLQUFtQyxFQUFFLEVBQUU7O1lBQzFFLElBQUksUUFBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sMENBQUUsT0FBTyxDQUFBO2dCQUMvQixPQUFPO1lBRVgsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0RixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsMkJBQTJCLEVBQUUsQ0FBQyxLQUFxQyxFQUFFLEVBQUU7WUFDOUUsS0FBSyxNQUFNLENBQUMsT0FBTyxFQUFFLGtCQUFrQixDQUFDLElBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNoRixJQUFJLGtCQUFrQixLQUFLLEtBQUssQ0FBQyxrQkFBa0I7b0JBQy9DLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDcEQ7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxpQkFBaUIsQ0FBRSxPQUFlO1FBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsT0FBTyxDQUFDO0lBQ25DLENBQUM7Q0FDSjtBQXJKRCx5Q0FxSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvdG9jb2wgZnJvbSAnZGV2dG9vbHMtcHJvdG9jb2wnO1xuaW1wb3J0IHsgQ2FsbHNpdGVSZWNvcmQgfSBmcm9tICdjYWxsc2l0ZS1yZWNvcmQnO1xuaW1wb3J0IFByb3RvY29sUHJveHlBcGkgZnJvbSAnZGV2dG9vbHMtcHJvdG9jb2wvdHlwZXMvcHJvdG9jb2wtcHJveHktYXBpJztcbmltcG9ydCBSdW50aW1lQXBpID0gUHJvdG9jb2xQcm94eUFwaS5SdW50aW1lQXBpO1xuaW1wb3J0IEV2YWx1YXRlUmVxdWVzdCA9IFByb3RvY29sLlJ1bnRpbWUuRXZhbHVhdGVSZXF1ZXN0O1xuaW1wb3J0IFJlbW90ZU9iamVjdCA9IFByb3RvY29sLlJ1bnRpbWUuUmVtb3RlT2JqZWN0O1xuaW1wb3J0IEV4Y2VwdGlvbkRldGFpbHMgPSBQcm90b2NvbC5SdW50aW1lLkV4Y2VwdGlvbkRldGFpbHM7XG5pbXBvcnQgUHJvcGVydHlQcmV2aWV3ID0gUHJvdG9jb2wuUnVudGltZS5Qcm9wZXJ0eVByZXZpZXc7XG5pbXBvcnQgRE9NQXBpID0gUHJvdG9jb2xQcm94eUFwaS5ET01BcGk7XG5pbXBvcnQgRXhlY3V0aW9uQ29udGV4dENyZWF0ZWRFdmVudCA9IFByb3RvY29sLlJ1bnRpbWUuRXhlY3V0aW9uQ29udGV4dENyZWF0ZWRFdmVudDtcbmltcG9ydCBFeGVjdXRpb25Db250ZXh0RGVzdHJveWVkRXZlbnQgPSBQcm90b2NvbC5SdW50aW1lLkV4ZWN1dGlvbkNvbnRleHREZXN0cm95ZWRFdmVudDtcbmltcG9ydCBET00gPSBQcm90b2NvbC5ET007XG5pbXBvcnQgKiBhcyBTaGFyZWRFcnJvcnMgZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vc2hhcmVkL2Vycm9ycyc7XG5pbXBvcnQge1xuICAgIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQsXG4gICAgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UsXG4gICAgRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCxcbn0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb2JzZXJ2YXRpb24nO1xuaW1wb3J0IHsgQXV0b21hdGlvbkVycm9yQ3RvcnMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi9zaGFyZWQvdHlwZXMnO1xuXG5cbmludGVyZmFjZSBFdmFsdWF0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgcmVxdWVzdDogRXZhbHVhdGVSZXF1ZXN0O1xuICAgIHJlc3BvbnNlOiB7IGNvZGU6IG51bWJlciB9O1xufVxuXG5pbnRlcmZhY2UgRXZhbHVhdGVTY3JpcHRSZXN1bHQge1xuICAgIHJlc3VsdDogUmVtb3RlT2JqZWN0IHwgbnVsbDtcbiAgICBleGNlcHRpb25EZXRhaWxzOiBFeGNlcHRpb25EZXRhaWxzIHwgbnVsbDtcbiAgICBlcnJvcjogRXZhbHVhdGlvbkVycm9yIHwgbnVsbDtcbn1cblxuaW50ZXJmYWNlIFNlbGVjdG9yU25hcHNob3RBcmdzIHtcbiAgICBSdW50aW1lOiBSdW50aW1lQXBpO1xuICAgIGNvbW1hbmQ6IEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQ7XG4gICAgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkO1xuICAgIHNlbGVjdG9yVGltZW91dDogbnVtYmVyO1xuICAgIGVyckN0b3JzOiBBdXRvbWF0aW9uRXJyb3JDdG9ycztcbn1cblxuaW50ZXJmYWNlIFNlbGVjdG9yTm9kZUFyZ3MgZXh0ZW5kcyBTZWxlY3RvclNuYXBzaG90QXJncyB7XG4gICAgRE9NOiBET01BcGk7XG59XG5cblxuY29uc3QgRVhFQ1VUSU9OX0NUWF9XQVNfREVTVFJPWUVEX0NPREUgPSAtMzIwMDA7XG5jb25zdCBTRUxFQ1RPUl9NQVhfRVhFQ1VURV9DT1VOVCAgICAgICA9IDEwO1xuY29uc3QgUFJPWFlMRVNTX1NDUklQVCAgICAgICAgICAgICAgICAgPSAnd2luZG93W1wiJXByb3h5bGVzcyVcIl0nO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaWVudEZ1bmN0aW9uRXhlY3V0b3Ige1xuICAgIC8vIG5ldyBNYXA8ZnJhbWVJZCwgZXhlY3V0aW9uQ29udGV4dElkPlxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuICAgIHByaXZhdGUgX2N1cnJlbnRGcmFtZUlkOiBzdHJpbmcgPSAnJztcblxuICAgIHB1YmxpYyBhc3luYyBldmFsdWF0ZVNjcmlwdCAoUnVudGltZTogUnVudGltZUFwaSwgZXhwcmVzc2lvbjogc3RyaW5nKTogUHJvbWlzZTxFdmFsdWF0ZVNjcmlwdFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBzY3JpcHQ6IEV2YWx1YXRlUmVxdWVzdCA9IHsgZXhwcmVzc2lvbiwgYXdhaXRQcm9taXNlOiB0cnVlIH07XG5cbiAgICAgICAgaWYgKHRoaXMuX2N1cnJlbnRGcmFtZUlkICYmIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuaGFzKHRoaXMuX2N1cnJlbnRGcmFtZUlkKSlcbiAgICAgICAgICAgIHNjcmlwdC5jb250ZXh0SWQgPSB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLmdldCh0aGlzLl9jdXJyZW50RnJhbWVJZCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzID0gbnVsbCB9ID0gYXdhaXQgUnVudGltZS5ldmFsdWF0ZShzY3JpcHQpO1xuXG4gICAgICAgICAgICByZXR1cm4geyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yOiBudWxsIH07XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4geyByZXN1bHQ6IG51bGwsIGV4Y2VwdGlvbkRldGFpbHM6IG51bGwsIGVycm9yIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9ldmFsdWF0ZVNjcmlwdFdpdGhSZWxvYWRQYWdlSWdub3JlIChSdW50aW1lOiBSdW50aW1lQXBpLCBleHByZXNzaW9uOiBzdHJpbmcpOiBQcm9taXNlPEV2YWx1YXRlU2NyaXB0UmVzdWx0PiB7XG4gICAgICAgIGxldCBhdHRlbXB0cyA9IDA7XG4gICAgICAgIGxldCByZXN1bHQ7XG4gICAgICAgIGxldCBleGNlcHRpb25EZXRhaWxzO1xuICAgICAgICBsZXQgZXJyb3I7XG5cbiAgICAgICAgd2hpbGUgKGF0dGVtcHRzKysgPCBTRUxFQ1RPUl9NQVhfRVhFQ1VURV9DT1VOVCkge1xuICAgICAgICAgICAgKHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5ldmFsdWF0ZVNjcmlwdChSdW50aW1lLCBleHByZXNzaW9uKSk7XG5cbiAgICAgICAgICAgIGlmIChlcnJvciAmJiBlcnJvci5yZXNwb25zZS5jb2RlID09PSBFWEVDVVRJT05fQ1RYX1dBU19ERVNUUk9ZRURfQ09ERSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW9iamVjdC1saXRlcmFsLXR5cGUtYXNzZXJ0aW9uXG4gICAgICAgIHJldHVybiB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3IgfSBhcyBFdmFsdWF0ZVNjcmlwdFJlc3VsdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfZ2V0UHJvcGVydHlCeU5hbWUgKHByb3BlcnRpZXM6IFByb3BlcnR5UHJldmlld1tdLCBuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICByZXR1cm4gcHJvcGVydGllcy5maW5kKHByb3AgPT4gcHJvcC5uYW1lID09PSBuYW1lKSEudmFsdWUhO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF90aHJvd0V4Y2VwdGlvbiAoZGV0YWlsczogRXhjZXB0aW9uRGV0YWlscywgY29tbWFuZDogRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UsIGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IG5ldmVyIHtcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gZGV0YWlscy5leGNlcHRpb247XG5cbiAgICAgICAgaWYgKGV4Y2VwdGlvbikge1xuICAgICAgICAgICAgY29uc3QgY2xhc3NOYW1lICA9IGV4Y2VwdGlvbi5jbGFzc05hbWU7XG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0gZXhjZXB0aW9uLnByZXZpZXc/LnByb3BlcnRpZXMgYXMgUHJvcGVydHlQcmV2aWV3W107XG5cbiAgICAgICAgICAgIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5VbmNhdWdodEVycm9ySW5DdXN0b21ET01Qcm9wZXJ0eUNvZGUubmFtZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuVW5jYXVnaHRFcnJvckluQ3VzdG9tRE9NUHJvcGVydHlDb2RlKGNvbW1hbmQuaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ2Vyck1zZycpLFxuICAgICAgICAgICAgICAgICAgICBDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl9nZXRQcm9wZXJ0eUJ5TmFtZShwcm9wZXJ0aWVzLCAncHJvcGVydHknKSxcbiAgICAgICAgICAgICAgICAgICAgY2FsbHNpdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuQ2Fubm90T2J0YWluSW5mb0ZvckVsZW1lbnRTcGVjaWZpZWRCeVNlbGVjdG9yRXJyb3IubmFtZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQ2Fubm90T2J0YWluSW5mb0ZvckVsZW1lbnRTcGVjaWZpZWRCeVNlbGVjdG9yRXJyb3IoY2FsbHNpdGUsIHtcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5DaGFpbjogY29tbWFuZC5hcGlGbkNoYWluLFxuICAgICAgICAgICAgICAgICAgICBhcGlGbkluZGV4OiBwYXJzZUludChDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl9nZXRQcm9wZXJ0eUJ5TmFtZShwcm9wZXJ0aWVzLCAnYXBpRm5JbmRleCcpLCAxMCksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5BY3Rpb25FbGVtZW50Tm90Rm91bmRFcnJvci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNoYXJlZEVycm9ycy5BY3Rpb25FbGVtZW50Tm90Rm91bmRFcnJvcihjYWxsc2l0ZSwge1xuICAgICAgICAgICAgICAgICAgICBhcGlGbkNoYWluOiBjb21tYW5kLmFwaUZuQ2hhaW4sXG4gICAgICAgICAgICAgICAgICAgIGFwaUZuSW5kZXg6IHBhcnNlSW50KENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX2dldFByb3BlcnR5QnlOYW1lKHByb3BlcnRpZXMsICdhcGlGbkluZGV4JyksIDEwKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGNsYXNzTmFtZSA9PT0gU2hhcmVkRXJyb3JzLkRvbU5vZGVDbGllbnRGdW5jdGlvblJlc3VsdEVycm9yLm5hbWUpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNoYXJlZEVycm9ycy5Eb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvcihjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNhbGxzaXRlKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKGNsYXNzTmFtZSA9PT0gU2hhcmVkRXJyb3JzLkludmFsaWRTZWxlY3RvclJlc3VsdEVycm9yLm5hbWUpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNoYXJlZEVycm9ycy5JbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvcihjYWxsc2l0ZSk7XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5BY3Rpb25FbGVtZW50SXNJbnZpc2libGVFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudElzSW52aXNpYmxlRXJyb3IoY2FsbHNpdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IFNoYXJlZEVycm9ycy5VbmNhdWdodEVycm9ySW5DbGllbnRGdW5jdGlvbkNvZGUoY29tbWFuZC5pbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBkZXRhaWxzLnRleHQsIGNhbGxzaXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUNsaWVudEZ1bmN0aW9uIChSdW50aW1lOiBSdW50aW1lQXBpLCBjb21tYW5kOiBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQpOiBQcm9taXNlPG9iamVjdD4ge1xuICAgICAgICBjb25zdCBleHByZXNzaW9uID0gYCR7UFJPWFlMRVNTX1NDUklQVH0uZXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZCgke0pTT04uc3RyaW5naWZ5KGNvbW1hbmQpfSk7YDtcblxuICAgICAgICBjb25zdCB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZXZhbHVhdGVTY3JpcHQoUnVudGltZSwgZXhwcmVzc2lvbik7XG5cbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UuY29kZSA9PT0gRVhFQ1VUSU9OX0NUWF9XQVNfREVTVFJPWUVEX0NPREUpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNoYXJlZEVycm9ycy5DbGllbnRGdW5jdGlvbkV4ZWN1dGlvbkludGVycnVwdGlvbkVycm9yKGNvbW1hbmQuaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgY2FsbHNpdGUpO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChleGNlcHRpb25EZXRhaWxzKVxuICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fdGhyb3dFeGNlcHRpb24oZXhjZXB0aW9uRGV0YWlscywgY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKHJlc3VsdCEudmFsdWUpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZVNlbGVjdG9yIDxUIGV4dGVuZHMgU2VsZWN0b3JTbmFwc2hvdEFyZ3MgfCBTZWxlY3Rvck5vZGVBcmdzPiAoYXJnczogVCk6IFByb21pc2U8VCBleHRlbmRzIFNlbGVjdG9yTm9kZUFyZ3MgPyBzdHJpbmcgOiBvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgeyBSdW50aW1lLCBjb21tYW5kLCBjYWxsc2l0ZSwgc2VsZWN0b3JUaW1lb3V0LCBlcnJDdG9ycyB9ID0gYXJncztcblxuICAgICAgICBjb25zdCByZXR1cm5Ob2RlT2JqSWQgPSAnRE9NJyBpbiBhcmdzO1xuICAgICAgICBjb25zdCBleHByZXNzaW9uICAgICAgPSBgJHtQUk9YWUxFU1NfU0NSSVBUfS5leGVjdXRlU2VsZWN0b3JDb21tYW5kKCR7SlNPTi5zdHJpbmdpZnkoY29tbWFuZCl9LCAke3NlbGVjdG9yVGltZW91dH0sICR7RGF0ZS5ub3coKX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3JldHVybk5vZGVPYmpJZH0sICR7SlNPTi5zdHJpbmdpZnkoZXJyQ3RvcnMpfSk7YDtcblxuICAgICAgICBjb25zdCB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3IgfSA9IGF3YWl0IHRoaXMuX2V2YWx1YXRlU2NyaXB0V2l0aFJlbG9hZFBhZ2VJZ25vcmUoUnVudGltZSwgZXhwcmVzc2lvbik7XG5cbiAgICAgICAgaWYgKGVycm9yKVxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG5cbiAgICAgICAgaWYgKGV4Y2VwdGlvbkRldGFpbHMpXG4gICAgICAgICAgICBDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl90aHJvd0V4Y2VwdGlvbihleGNlcHRpb25EZXRhaWxzLCBjb21tYW5kLCBjYWxsc2l0ZSk7XG5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgcmV0dXJuIHJldHVybk5vZGVPYmpJZCA/IHJlc3VsdCEub2JqZWN0SWQgOiBKU09OLnBhcnNlKHJlc3VsdCEudmFsdWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXROb2RlIChhcmdzOiBTZWxlY3Rvck5vZGVBcmdzKTogUHJvbWlzZTxET00uTm9kZT4ge1xuICAgICAgICBjb25zdCBvYmplY3RJZCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVNlbGVjdG9yKGFyZ3MpO1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFyZ3MuRE9NLmRlc2NyaWJlTm9kZSh7IG9iamVjdElkIH0pO1xuXG4gICAgICAgIHJldHVybiByZXNwb25zZS5ub2RlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXR1cEZyYW1lc1dhdGNoaW5nIChSdW50aW1lOiBSdW50aW1lQXBpKTogdm9pZCB7XG4gICAgICAgIFJ1bnRpbWUub24oJ2V4ZWN1dGlvbkNvbnRleHRDcmVhdGVkJywgKGV2ZW50OiBFeGVjdXRpb25Db250ZXh0Q3JlYXRlZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIWV2ZW50LmNvbnRleHQuYXV4RGF0YT8uZnJhbWVJZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuc2V0KGV2ZW50LmNvbnRleHQuYXV4RGF0YS5mcmFtZUlkLCBldmVudC5jb250ZXh0LmlkKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgUnVudGltZS5vbignZXhlY3V0aW9uQ29udGV4dERlc3Ryb3llZCcsIChldmVudDogRXhlY3V0aW9uQ29udGV4dERlc3Ryb3llZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IFtmcmFtZUlkLCBleGVjdXRpb25Db250ZXh0SWRdIG9mIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuZW50cmllcygpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHRJZCA9PT0gZXZlbnQuZXhlY3V0aW9uQ29udGV4dElkKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLmRlbGV0ZShmcmFtZUlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgUnVudGltZS5vbignZXhlY3V0aW9uQ29udGV4dHNDbGVhcmVkJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fY3VycmVudEZyYW1lSWQgPSAnJztcbiAgICAgICAgICAgIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuY2xlYXIoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldEN1cnJlbnRGcmFtZUlkIChmcmFtZUlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fY3VycmVudEZyYW1lSWQgPSBmcmFtZUlkO1xuICAgIH1cbn1cbiJdfQ==